<%- include("partials/header") -%>

<div class="heading">
    <h1>Home</h1>
</div>
<div class="content">

    <div class="backgroundDiv add-post-box" >
        
        <div class="profile-image-post">
            <img id="profile-image-display" >
        </div>
        
        <div class="post-upload-content">
           
                <form onsubmit="return doPost(this);" class="post-content">
                    <input name="type" type="hidden" value="post">
                    <input type="text" class="caption-area" placeholder="Caption for your Post ! " style="display: block;
                    margin:10px;
                    width: 80%;
                    background: transparent;
                    border: none;
                    outline: none;
                    text-align:center;
                    font-size: 20px;
                    color: rgb(122, 121, 120);
                    "  name="caption" autocomplete="off" maxlength="250" required>
                    <div class="imag-video-display">

                        <img style=" display: none; width: 300px; height: 300px; outline: none;"  class="imag-display" >
                        <video style="display: none; width: 300px; height: 300px; outline: none;"  controls class="video-display" ></video>

                    </div>
                    <div class="post-icons">
                        <label >
                            <img src="/public/icons/uploadImage.svg" alt="imageUpload" style="height: 30px; width: 30px; margin: 5px;">
                            <input type="file" name="image" id="image-post" style="display: None;" accept="image/*" onchange= "previewPostImage(this);">
                        </label>
                        <label >
                            <img src="/public/icons/uploadVideo.svg" alt="videoUpload" style="height: 30px; width: 30px; margin: 5px;">
                            <input type="file" name="video" id="video-post" style="display: None;" accept="video/*" onchange= "previewPostVideo(this);">
                        </label>
                        
                        <button type="submit" style="margin: 5px;
                        width:50px;
                        ">
                            Post
                        </button>
    
                    </div>
                
                </form>
                

           
       

        </div>
        
    </div>


    <div id="newsFeed" >

    </div>
    

</div>



<script>

function previewPostImage(self)
{
    var file = self.files;
    if (file.length>0)
    {
        var fileReader= new FileReader();
        fileReader.onload= function (event)
        {   
            document.getElementById("video-post").value="";
            document.getElementsByClassName("video-display")[0].style.display="none";
            document.getElementsByClassName("imag-display")[0].style.display="block";
            document.getElementsByClassName("add-post-box")[0].style.height="500px";
            document.getElementsByClassName("post-content")[0].style.height="450px";
            document.getElementsByClassName("imag-display")[0].setAttribute("src",event.target.result);
            document.getElementsByClassName("video-display")[0].setAttribute("src","");

        }
        fileReader.readAsDataURL(file[0]);
    }

}

function previewPostVideo(self)
{
    var file=self.files;
    if (file.length>0)
    {
        var fileReader= new FileReader();
        fileReader.onload= function (event)
        {   
            document.getElementById("image-post").value="";
            document.getElementsByClassName("imag-display")[0].style.display="none";
            document.getElementsByClassName("video-display")[0].style.display="block";
            document.getElementsByClassName("add-post-box")[0].style.height="500px";
            document.getElementsByClassName("post-content")[0].style.height="450px";
            document.getElementsByClassName("imag-display")[0].setAttribute("src","");
            document.getElementsByClassName("video-display")[0].setAttribute("src",event.target.result);

        }
        fileReader.readAsDataURL(file[0]);
    }

}



      
function createLikesSection(data)
     {
         var isLiked = false;
         for (var b = 0; b < data.likers.length; b++) {
             var liker = data.likers[b];
             if (liker._id == window.user._id) {
                 isLiked = true;
                 break;
             }
         }
     
         var html = "";
         html+='<div class="like-comment" style="display: flex;flex-direction: row;align-content: space-evenly;justify-content: space-around;padding-top: 10px;">'
             var className = "";
             if (isLiked) {
                 className = "like";
             } else {
                 className = "none";
             }
     
        html+=' <span class="'+ className+'" onclick="toggleLikePost(this); " data-id="' + data._id + '" ><i class="ti-thumb-up" style="font-size: 30px;"></i>';
        html+=' <ins style="font-size: 20px;">'+data.likers.length+'</ins></span>';
         
             html += '<span class="comment" title="Comments">';
                 html+='<i class="ti-comments" style="font-size: 30px;"></i>';
                 html+='<ins style="font-size: 20px;"  id="count-post-comments-' + data._id + '">' + data.comments.length + '</ins>';
                 html+='</span>';
     
             html+='<span class="share" onclick="sharePost(this);" data-id="' + data._id + '">';
                 html+='<i class="ti-share" style="font-size: 30px;"></i>';
                 html+='<ins style="font-size: 20px;" >' + data.shares.length + '</ins>';
                 html+=' </span></div>';
         return html;            
     
     
     }
     


function toggleLikePost(self)
     {
         var _id = self.getAttribute("data-id");
         var ajax = new XMLHttpRequest();
         ajax.open("POST", "/toggleLikePost", true);
     
         ajax.onreadystatechange = function(){
             if (this.readyState == 4 && this.status == 200)
             {
                 var response = JSON.parse(this.responseText);
     
                 if (response.status == "success") {
                     self.className = "like";
     
                     var likes = parseInt(self.querySelector("ins").innerHTML);
                     likes++;
                     self.querySelector("ins").innerHTML = likes;
                     }
                 if (response.status == "unliked") {
                     self.className = "none";
                     var likes = parseInt(self.querySelector("ins").innerHTML);
                     likes--;
                     self.querySelector("ins").innerHTML = likes;
                     }
                 if (response.status == "error") {
                     alert(response.message);
                     }
             }
     
     
         };
     
         var formData = new FormData();
         formData.append("accessToken", localStorage.getItem("accessToken"));
         formData.append("_id", _id);
         ajax.send(formData);
     
     
     }
   
function createCommentsSection(data)
{
    var html="";
    html+='<div class="comment-section" >';
        html+='<div class="comment-input" ">';
            html+='<a href="/user/'+ window.user.username +'" style="display: flex; align-items: center; color:black; text-decoration: none;">';
                html+='<img src="' + mainURL + '/' + window.user.profileImage + '" class="comment-input-image" >';
                html+='<label  class="comment-input-username" ><h4>'+ window.user.username+'</h4> </label></a>';
                html+='<form method="post" onsubmit="return doPostComment(this);" class="comment-input-form">';
                    html += '<input type="hidden" name="_id" value="' + data._id + '">';
                    html += '<textarea class="comment-textarea" name="comment" placeholder="Post your comment" cols="20" rows="2"></textarea>';
                    html += '<button type="submit" style="width: 80px">Comment</button>';
                    html+='</form></div>';
                    html+='<div class="scroll-bar">'
                   
                        data.comments = data.comments.reverse();
                        for (var b = 0; b <data.comments.length; b++)
                        {
                            var comment = data.comments[b];
                            html+='<div class="comment-display">';
                            html+='<div class="user-details">';
                                html+='<a href="/user/'+comment.user.username+'" style="display: flex; align-items: center; color:black; text-decoration: none;">';
                                    var proImage=getProfileImage(comment.user._id);
                                    html+='<img src="'+mainURL + '/' + proImage +'" style="width: 60px; height:60px;border-radius: 100%; margin: 10px; " >';
                                    html+='<label  style="margin-left: 10px; margin-right: 10px;"><h4>'+comment.user.username+'</h4></label>';
                                    var createdAt = new Date(comment.createdAt);
									var date = createdAt.getDate() + "";
									date = date.padStart(2, "0") + " " + months[createdAt.getMonth()] + ", " + createdAt.getFullYear();
                                    html += '<span>' + date + '</span>';
                                    html += '<a class="we-reply" href="javascript:void(0);" style="color:black; text-decoration: none; margin-left:10px; font-size: larger; " data-post-id="' + data._id + '" data-comment-id="' + comment._id + '" onclick="prepareToReply(this);" title="Reply"><i class="ti-control-backward"></i></a>';
                                    html+='</div>';
                                    html+='<div class="user-comment" >';
                                        html+=comment.comment;
                                        html+='</div>';
                                        comment.replies = comment.replies.reverse();
                                        for (var c = 0; c < comment.replies.length; c++)
                                        {
                                            var reply = comment.replies[c];
                                            html+='<div class="reply-display" >';
                                                html+='<div class="user-details" >';
                                                    html+='<a href="/user/'+reply.user.username +'" style="display: flex; align-items: center;color:black; text-decoration: none;" >';
                                                        var proImage=getProfileImage(reply.user._id);
                                                        html+='<img src="' + mainURL + '/' + proImage + '" style="width: 50px;height:50px; border-radius: 100%;margin-right: 10px;" >';
                                                        html+='<label  style="margin-left: 10px; margin-right: 10px;"><h4>'+ reply.user.username+'</h4> </label>';
                                                        var createdAt = new Date(reply.createdAt);
												var date = createdAt.getDate() + "";
                                                date = date.padStart(2, "0") + " " + months[createdAt.getMonth()] + ", " + createdAt.getFullYear();
                                                html += '<span>' + date + '</span>';
                                                html+=' </a></div>';
                                                html+='<div class="user-comment" >';
                                                html+=reply.reply;
                                                    html += '</div></div>';


                                        }

                                        html+='</div>';
                        }
                        html+='</div>';
                        html+='</div>';
                    return html;
}

function sharePost(self){
    if (confirm("Are you sure you want to share this post ?")){
        var _id = self.getAttribute("data-id");
		var ajax = new XMLHttpRequest();
        ajax.open("POST", "/sharePost", true);
        ajax.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                var response = JSON.parse(this.responseText);
                alert(response.message);
                if (response.status == "success"){
                    self.className = "like";
                    var shares = parseInt(self.querySelector("ins").innerHTML);
                    shares++;
                    self.querySelector("ins").innerHTML = shares;
                    showNewsfeed();
                }
            }
        };
        var formData = new FormData();
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("_id", _id);
        ajax.send(formData);
    
    }
}

function doPostComment(form)
{
    var ajax = new XMLHttpRequest();
    ajax.open("POST", "/postComment",true);

    ajax.onreadystatechange = function()
    {
        if (this.readyState == 4 && this.status == 200) {

            var response = JSON.parse(this.responseText);
            alert(response.message);

            if (response.status == "success") {
                form.comment.value = "";

                var commentsHtml = createCommentsSection(response.updatePost);
                document.getElementById("post-comments-" + form._id.value).innerHTML = commentsHtml;

                var comments = parseInt(document.getElementById("count-post-comments-" + form._id.value).innerHTML);
                comments++;
                document.getElementById("count-post-comments-" + form._id.value).innerHTML = comments;
            }
        }

    };
    var formData = new FormData(form);
    formData.append("accessToken", localStorage.getItem("accessToken"));
    ajax.send(formData);

    return false;
}

function prepareToReply(self) {
    $("#replyModal input[name='postId']").val(self.getAttribute("data-post-id"));
    $("#replyModal input[name='commentId']").val(self.getAttribute("data-comment-id"));
    $("#replyModal").modal("show");
}

function doPostReply(form) {
    var ajax = new XMLHttpRequest();
    ajax.open("POST", "/postReply",true);

    ajax.onreadystatechange = function() {
        if (this.readyState == 4 && this.status == 200) {

            var response = JSON.parse(this.responseText);
            alert(response.message);

            if (response.status == "success") {
                form.reply.value = "";
                $("#replyModal").modal("hide");

                var commentsHtml = createCommentsSection(response.updatePost);
                document.getElementById("post-comments-" + form.postId.value).innerHTML = commentsHtml;
            }
        }
    };

    var formData = new FormData(form);
    formData.append("accessToken", localStorage.getItem("accessToken"));
    ajax.send(formData);

    return false;
			}

function deletePost(self)
{
    if (confirm("Are you sure you want to delete this post ?")){
        var _id = self.getAttribute("data-id");
		var ajax = new XMLHttpRequest();
        ajax.open("POST", "/deletePost", true);
        ajax.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                var response = JSON.parse(this.responseText);
                alert(response.message);
                if (response.status == "success"){
                    showNewsfeed();
                }


            }
        };
        var formData = new FormData();
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("_id", _id);
        ajax.send(formData);
    }
}

function getProfileImage(id)
{
    var ajax = new XMLHttpRequest();
    var imageAddress="";
    ajax.open("POST","/getprofileImage",true)
    ajax.onreadystatechange=function()
    {
        if (this.readyState == 4 && this.status == 200)
        {
            var response=JSON.parse(this.responseText);
            
            if (response.status == "success"){
                
               imageAddress = response.profileimage;
                
                console.log("in IF block = "+imageAddress);
                return imageAddress;
                }
            
        }

    };
    var formData = new FormData();
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("userid",id);
        ajax.send(formData);

    
}

function showNewsfeed()
    {
         var ajax = new XMLHttpRequest();
         ajax.open("POST", "/getNewsfeed",true);
     
         ajax.onreadystatechange=function()
         {
             if(this.readyState == 4 && this.status == 200)
             {
                 var response = JSON.parse(this.responseText);
                 var html = "";
                     for (var a = 0; a < response.data.length; a++)
                    {
                        var data = response.data[a];
     
                        html+='<div class="backgroundDiv postCard">';
                            html+='<div class="username-profileimage" >';
                                html+='<label >';
                                    html+='<a href="/user/'+data.user.username+'" style="display: flex; align-items: center; text-decoration: none; color: black; margin: 10px 0;">';
                                        var proImage=getProfileImage(data.user._id);
                                        //console.log(proImage);
                                    html+='<img style="width: 60px; height: 60px; border-radius: 100%;margin: 0 20px; " class="postcard-profileImage" src="' + mainURL + "/" + proImage + '">';
                                    html+='<label style="display: flex; flex-direction: column;" ><h3 >'+data.user.username+'</h3>';
                                    var createdAt = new Date(data.createdAt);
                                    var date = createdAt.getDate() + "";
                                    date = date.padStart(2, "0") + " " + months[createdAt.getMonth()] + ", " + createdAt.getFullYear();                         
                                    html+='<h4 style="font-weight: lighter;">'+date+'</h4></label></a></label>';
                                    if(data.user.username==window.user.username)
                                    {
                                        html+='<span class="delete" onclick="deletePost(this);" data-id="' + data._id + '">';
                                            html+='<i class="ti-trash" style="font-size: 30px;"></i>';
                                            html+='</span>';
                                    }
                                    html+='</div>';
                                    html+='<div class="post-image-video" style="padding: 10px; border-bottom: 1px solid rgba(133, 130, 130, 0.486);">';
                                    if (data.image != "") {
                                        html+='<img src="' + mainURL + "/" + data.image + '" style="height: 300px; width: 300px; padding: 10px; ">';
                                    }
                                    if (data.video != "") {
                                        html+='<video style="height: 300px; width: 300px; padding: 10px; outline: none;" controls src="' + mainURL + "/" + data.video + '"></video>';     
                                    }
                                        
                                    html+='<div class="post-caption">'+ data.caption+'</div></div>';
                                    html+=createLikesSection(data);
                                    html += "<div id='post-comments-" + data._id + "'>";
                                    html += createCommentsSection(data);
							        html += "</div>";
                                    html+='</div>';
                    }
                     document.getElementById("newsFeed").innerHTML=html;
             }
         };
         var formData = new FormData();
         formData.append("accessToken", localStorage.getItem("accessToken"));
         ajax.send(formData);
    }
     
function doPost(form)
{
    var ajax=new XMLHttpRequest();
    ajax.open("POST","/addPost",true);
    ajax.onreadystatechange = function()
    {
        if( this.readyState == 4 && this.status==200)
        {
            var response=JSON.parse(this.responseText);
            alert(response.message);
            if(response.status=="success")
            {
                document.getElementById("video-post").value="";
                document.getElementById("image-post").value="";
                document.getElementsByClassName("caption-area")[0].value="";
                document.getElementsByClassName("add-post-box")[0].style.height="200px";
                document.getElementsByClassName("post-content")[0].style.height="150px";
                document.getElementsByClassName("imag-display")[0].style.display="none";
                document.getElementsByClassName("video-display")[0].style.display="none";
                document.getElementsByClassName("imag-display")[0].setAttribute("src","");
                document.getElementsByClassName("video-display")[0].setAttribute("src","");



            }

        }
    };
    var formData =new FormData(form);
    formData.append("accessToken",localStorage.getItem("accessToken"));
    ajax.send(formData);
    return false;
}






</script>


<%- include("partials/footer") -%>